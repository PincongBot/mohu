{"type":"article","id":140,"title":"论 NAT6（IPv6 NAT）","uid":6,"topics":[490,581,764,2413,4993],"contents":"《ER-X 折腾计划》便讲过。<br>\n<br>\n实际上这次的教程可以适配任何 OpenWrt 支持的设备，不仅限于 ER-X。<br>\n<br>\n要进行 IPv6 NAT，就必须安装上 kmod-ipt-nat6，而这个包 OpenWrt 不自带，所以：<br>\n<pre>opkg&nbsp;update<br>\n<br>\nopkg&nbsp;install&nbsp;kmod-ipt-nat6</pre><br>\n或者在 LuCI 拉取软件源，然后查找 kmod-ipt-nat6 安装：<br>\n<br>\n<a href=\"https://mhimg.github.io/ueditor/20180629/1530256590730811.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://mhimg.github.io/ueditor/20180629/1530256590730811.png\" alt=\"https://mhimg.github.io/ueditor/20180629/1530256590730811.png\" style=\"max-width:100%\"></a><br>\n<br>\n非常地简单（大嘘）<br>\n<br>\n然后我们要注意，如果 LAN 的地址段属于 ULA，那么 OpenWrt 便不会公布网关，所以需要勾选：<br>\n<br>\n<a href=\"https://mhimg.github.io/ueditor/20180629/1530256617675163.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://mhimg.github.io/ueditor/20180629/1530256617675163.png\" alt=\"https://mhimg.github.io/ueditor/20180629/1530256617675163.png\" style=\"max-width:100%\"></a><br>\n<br>\n那么如何开启 NAT6 呢？在防火墙的自定义规则加如下：<br>\n<br>\n<a href=\"https://mhimg.github.io/ueditor/20180629/1530256638424746.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://mhimg.github.io/ueditor/20180629/1530256638424746.png\" alt=\"https://mhimg.github.io/ueditor/20180629/1530256638424746.png\" style=\"max-width:100%\"></a><br>\n<pre>#&nbsp;定义&nbsp;IPv6&nbsp;WAN&nbsp;接口名（Linux）<br>\n<br>\niface_linux=pppoe-wan<br>\n<br>\n#&nbsp;建立&nbsp;IPv6&nbsp;NAT<br>\n<br>\nip6tables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;POSTROUTING&nbsp;-o&nbsp;$iface_linux&nbsp;-j&nbsp;MASQUERADE</pre><br>\n其中 iface_linux 便是：<br>\n<br>\n<a href=\"https://mhimg.github.io/ueditor/20180629/1530256731323526.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://mhimg.github.io/ueditor/20180629/1530256731323526.png\" alt=\"https://mhimg.github.io/ueditor/20180629/1530256731323526.png\" style=\"max-width:100%\"></a><br>\n<br>\nこ↑こ↓。按下「重启防火墙」保存。<br>\n<br>\n但是一般我们拨号拨出来的网关是 fe80 开头的网关，所以可以在 /etc/hotplug.d/iface 建立个脚本，来自动添加路由表。<br>\n<br>\n先在 /etc/hotplug.d/iface 建立 99-ipv6。当然 hotplug 的脚本其实不必 chmod +x。<br>\n<br>\n脚本内容如下：<br>\n<pre>#!/bin/sh<br>\n<br>\n[&nbsp;\"$ACTION\"&nbsp;=&nbsp;ifup&nbsp;]&nbsp;||&nbsp;exit&nbsp;0<br>\n<br>\n#&nbsp;定义&nbsp;IPv6&nbsp;WAN&nbsp;接口名（UCI）<br>\n<br>\niface_uci=wan_6<br>\n<br>\n#&nbsp;定义&nbsp;IPv6&nbsp;WAN&nbsp;接口名（Linux）<br>\n<br>\niface_linux=pppoe-wan<br>\n<br>\n[&nbsp;-z&nbsp;\"$iface_uci\"&nbsp;-o&nbsp;\"$INTERFACE\"&nbsp;=&nbsp;\"$iface_uci\"&nbsp;]&nbsp;||&nbsp;exit&nbsp;0<br>\n<br>\nip&nbsp;-6&nbsp;route&nbsp;add&nbsp;`ip&nbsp;-6&nbsp;route&nbsp;|&nbsp;grep&nbsp;$iface_linux&nbsp;|&nbsp;grep&nbsp;via&nbsp;|&nbsp;sed&nbsp;-e&nbsp;'s/from&nbsp;[^&nbsp;]*&nbsp;//'&nbsp;|&nbsp;sed&nbsp;-e&nbsp;'2,$d'`<br>\n<br>\nlogger&nbsp;-t&nbsp;IPv6&nbsp;\"Add&nbsp;IPv6&nbsp;default&nbsp;route.\"</pre><br>\niface_linux 已经讲过了，但是 iface_uci 又没讲过。其实：<br>\n<br>\n<a href=\"https://mhimg.github.io/ueditor/20180629/1530256844336948.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://mhimg.github.io/ueditor/20180629/1530256844336948.png\" alt=\"https://mhimg.github.io/ueditor/20180629/1530256844336948.png\" style=\"max-width:100%\"></a><br>\n<br>\n但是泽个东西 LuCI 在显示的时候全部转成了大写，就会踩到大小写民感的雷。<br>\n<br>\n<a href=\"https://mhimg.github.io/ueditor/20180629/1530256860734762.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://mhimg.github.io/ueditor/20180629/1530256860734762.png\" alt=\"https://mhimg.github.io/ueditor/20180629/1530256860734762.png\" style=\"max-width:100%\"></a><br>\n<br>\n然后看看地址栏。<br>\n<br>\n<a href=\"https://mhimg.github.io/ueditor/20180629/1530256875985273.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://mhimg.github.io/ueditor/20180629/1530256875985273.png\" alt=\"https://mhimg.github.io/ueditor/20180629/1530256875985273.png\" style=\"max-width:100%\"></a><br>\n<br>\n嗯，所以是小写的「wan」。那么上面的脚本为什么写「wan_6」？<br>\n<br>\n因为 OpenWrt 对 PPPoE 会虚拟出一个 IPv6 接口，其 UCI 名是原本的名称后面接上「_6」。如果是 DHCPv6 客户端模式就不用加。<br>\n<br>\n然后重启路由器，不出意外的话 NAT6 就成功了：<br>\n<br>\n<a href=\"https://mhimg.github.io/ueditor/20180629/1530256994847631.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://mhimg.github.io/ueditor/20180629/1530256994847631.png\" alt=\"https://mhimg.github.io/ueditor/20180629/1530256994847631.png\" style=\"max-width:100%\"></a><br>\n<br>\n<a href=\"https://mhimg.github.io/ueditor/20180629/1530257009213357.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://mhimg.github.io/ueditor/20180629/1530257009213357.png\" alt=\"https://mhimg.github.io/ueditor/20180629/1530257009213357.png\" style=\"max-width:100%\"></a><br>\n<br>\n<a href=\"https://mhimg.github.io/ueditor/20180629/1530257012587756.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://mhimg.github.io/ueditor/20180629/1530257012587756.png\" alt=\"https://mhimg.github.io/ueditor/20180629/1530257012587756.png\" style=\"max-width:100%\"></a><br>\n<br>\n<a href=\"https://mhimg.github.io/ueditor/20180629/1530257022485289.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://mhimg.github.io/ueditor/20180629/1530257022485289.png\" alt=\"https://mhimg.github.io/ueditor/20180629/1530257022485289.png\" style=\"max-width:100%\"></a><br>\n<br>\n（由此还能看出电信的 IPv6 还跑到了 CERNET（教育网）……其实三大运营商的 IPv6 差不多都是）<br>\n<br>\n最后看完这篇的大佬们，谢谢茄子，，，<br>\n[h]（2018 年 7 月 4 日）[/h]<br>\n首先要补充的是，如果地址是 ULA 的话，那么像 Android 等系统可能会优先解析 IPv4。为了避免这种情况，只好不使用 ULA 了。<br>\n<br>\n但是这个地址也不能乱设，不然冲突了就不好了。所以我们从 <br>\n<br>\n这个有 Note 的区块我们也不方便用，因为应该是有了用途的。那么我们可以瞄一个无 Note 的区块。<br>\n<br>\n<a href=\"https://mhimg.github.io/ueditor/20180704/1530712662687105.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://mhimg.github.io/ueditor/20180704/1530712662687105.png\" alt=\"https://mhimg.github.io/ueditor/20180704/1530712662687105.png\" style=\"max-width:100%\"></a><br>\n<br>\n这块可以有！<br>\n<br>\n事实上 <br>\n<br>\n（按：d000::/4 显然属于 c000::/3 的一部分）<br>\n<br>\n当然，其实我不建议滥用地址，但是迫不得已的情况下不影响到他人（冲突）就没事。<br>\n<br>\n那么我来谈谈为什么要用 IPv6 NAT。<br>\n<br>\n事实上，家用 IPv6 的前缀会变化。而且你也保不准会不会拿到 /128 的地址。<br>\n<br>\n拿到 /128 也只好自认倒楣了。而前缀变化意味着……试想你 IPv6 上得好好的，断线重连原来的地址就失效了（<br>\n<br>\n所以我的意思很明白了，，，这种情况下用 Relay 反而不太方便，，，<br>\n[h]（2018 年 7 月 31 日）[/h]<br>\n今天，OpenWrt 18.06.0 发布！<br>\n<br>\n其实单是对比 RC2 和 RC1，LuCI 也有了明显变动。<br>\n<br>\n<a href=\"https://mhimg.github.io/ueditor/20180811/1533948472795394.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://mhimg.github.io/ueditor/20180811/1533948472795394.png\" alt=\"https://mhimg.github.io/ueditor/20180811/1533948472795394.png\" style=\"max-width:100%\"></a><br>\n<br>\n而且 RC2 引入的 LuCI 版本已经明确显示了虚拟的 PPPoE IPv6 接口。<br>\n<br>\n<a href=\"https://mhimg.github.io/ueditor/20180811/1533948499394665.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://mhimg.github.io/ueditor/20180811/1533948499394665.png\" alt=\"https://mhimg.github.io/ueditor/20180811/1533948499394665.png\" style=\"max-width:100%\"></a><br>\n<br>\n注意「协议：虚拟动态接口（DHCPv6 客户端）」这一点。这无疑为我们对虚拟接口的判断提供了便利。<br>\n<br>\n目前我先升级了 RC2，至于正式版等待编译完毕再说吧。将在《ER-X 折腾计划》持续更新。<br>\n[h]（2018 年 8 月 11 日）[/h]<br>\n除了安装 kmod-ipt-nat6 外，我们还可以选择安装 ip6tables-mod-nat，这样应该就能扩展 DNPT 和 SNPT 了。","date":"2018-06-29","agreeCount":1,"discussionCount":0}